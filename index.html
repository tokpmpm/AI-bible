<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šAIå°ˆæ¥­è§£ç¶“ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #121212; --text-color: #e0e0e0; --primary-color: #007bff;
            --card-bg: #1e1e1e; --border-color: #333; --input-bg: #2a2a2a;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 1rem; line-height: 1.6;
        }
        main { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; }
        header { text-align: center; }
        h1 { color: var(--primary-color); margin-bottom: 0.5rem; }
        p.subtitle { color: #aaa; font-style: italic; margin-top: 0; }
        .info-section { color: #ccc; font-size: 0.95rem; margin: 1rem 0; }
        .info-section a { color: var(--primary-color); text-decoration: none; }
        .info-section a:hover { text-decoration: underline; }
        .form-section {
            background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem;
        }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        select {
            width: 100%; padding: 0.8rem; background-color: var(--input-bg); border: 1px solid var(--border-color);
            border-radius: 4px; color: var(--text-color); font-size: 1rem; box-sizing: border-box;
        }
        .selectors-grid { 
            display: grid; 
            grid-template-columns: 1fr;
            gap: 1rem; 
        }
        .range-selector-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
        }
        @media (min-width: 600px) {
            .selectors-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .models { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .model-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        input[type="checkbox"] { width: 1.5em; height: 1.5em; }
        button {
            width: 100%; padding: 1rem; background-color: var(--primary-color); color: white; border: none;
            border-radius: 4px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;
        }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #results-container { display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1.5rem; }
        .result-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; animation: fadeIn 0.5s ease; }
        .result-card h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .result-card.error h2 { color: #f44336; }
        .content-body { word-wrap: break-word; font-family: inherit; font-size: 1rem; }
        .content-body h1, .content-body h2, .content-body h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin-top: 1.5em; }
        .content-body ul, .content-body ol { padding-left: 2em; }
        .content-body li { margin-bottom: 0.5em; }
        .content-body a { color: var(--primary-color); text-decoration: none; }
        .content-body a:hover { text-decoration: underline; }
        .content-body sup { line-height: 0; }
        .content-body .sources-list { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .content-body .sources-list h3 { margin-top: 0; color: var(--primary-color); }
        .content-body .sources-list ol { padding-left: 1.5em; }
        .content-body .sources-list li { margin-bottom: 0.8em; }
        .content-body .sources-list a { color: var(--primary-color); text-decoration: underline; }
        .content-body .sources-list a:hover { opacity: 0.8; }
        .content-body .sources-list .source-domain { color: #aaa; font-size: 0.9em; margin-left: 0.5em; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 2rem auto; }
        .sponsorship-section { margin: 1.5rem 0 0.5rem; }
        .bmc-button { display: inline-block; padding: 10px 20px; background-color: #FFDD00; color: #000000; border-radius: 8px; text-decoration: none; font-weight: bold; transition: background-color 0.3s ease, transform 0.2s ease; }
        .bmc-button:hover { background-color: #FFE766; transform: scale(1.05); }

        #go-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }
        #go-to-top-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .card-actions {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        .copy-btn {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .copy-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <main>
        <header>
            <h1>å¤šAIå°ˆæ¥­è§£ç¶“ç³»çµ±</h1>
            <p class="subtitle">æ¯”è¼ƒ ChatGPT, Gemini, Perplexity çš„ç¶“ç¯€åˆ†æ</p>
            <p class="subtitle">å› ç‚ºå‘¼å« API éœ€è¦è²»ç”¨,ç›®å‰æ¡ç”¨æ˜¯æ€§åƒ¹æ¯”è¼ƒé«˜çš„æ¨¡å‹,ä¸æ˜¯æœ€ä½³æ¨¡å‹,AI è§£ç¶“è‹¥æœ‰åå·®,è«‹å¤šåŒ…å®¹</p>
            <div class="info-section">
                <p>æƒ³çŸ¥é“<a href="https://lihi3.me/WfbvE" target="_blank" rel="noopener noreferrer"> å„ AI è§£ç¶“æœ‰ä»€éº¼å·®ç•°çš„å¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç« </a></p>
                <p>æœ‰ä»€éº¼å»ºè­°æ­¡è¿è·Ÿæˆ‘èªª,ç›®å‰è¨­å®šæ˜¯ä»¥å°è–ç¶“æœ‰ä¸­ç­‰äº†è§£çš„æœ‹å‹ç‚ºä¸»ä¾†è§£ç¶“</p>
            </div>
            <div class="sponsorship-section">
                <a href="https://buymeacoffee.com/tokpmpm" target="_blank" class="bmc-button">
                    â˜• æ­¡è¿è´ŠåŠ©æ”¯æŒé€™å€‹å°ˆæ¡ˆ
                </a>
            </div>
        </header>

        <form id="bible-form" class="form-section">
            <div class="form-group">
                <label for="book-select">é¸æ“‡æ›¸å·</label>
                <select id="book-select" required></select>
            </div>
            <div class="form-group">
                <label>é¸æ“‡ç¶“ç¯€ç¯„åœ</label>
                <div class="selectors-grid">
                    <div>
                        <label for="start-chapter-select" style="font-size: 0.9em; color: #ccc;">å¾</label>
                        <div class="range-selector-group">
                            <select id="start-chapter-select" required></select>
                            <select id="start-verse-select" required></select>
                        </div>
                    </div>
                     <div>
                        <label for="end-chapter-select" style="font-size: 0.9em; color: #ccc;">åˆ°</label>
                        <div class="range-selector-group">
                            <select id="end-chapter-select" required></select>
                            <select id="end-verse-select" required></select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>é¸æ“‡è¦æŸ¥è©¢çš„ AI æ¨¡å‹</label>
                <div class="models">
                    <div class="model-checkbox"><input type="checkbox" id="use-chatgpt" value="chatgpt" checked><label for="use-chatgpt">ChatGPT 4o</label></div>
                    <div class="model-checkbox"><input type="checkbox" id="use-gemini" value="gemini" checked><label for="use-gemini">Gemini 2.5 Pro</label></div>
                    <div class="model-checkbox"><input type="checkbox" id="use-perplexity" value="perplexity" checked><label for="use-perplexity">Perplexity Sonar Reasoning Pro</label></div>
                </div>
            </div>

            <button type="submit" id="submit-btn">é–‹å§‹è§£ç¶“</button>
        </form>

        <div id="results-container"></div>
    </main>
    
    <button id="go-to-top-btn" title="å›åˆ°æœ€ä¸Šé ">&#8679;</button>
    
    <script src="config.js" defer></script> 
    <script src="bible-data.js" defer></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let lastSubmitTime = 0;
        const SUBMIT_COOLDOWN = 50000;
        let currentReference = '';
        
        const bookSelect = document.getElementById('book-select');
        const startChapterSelect = document.getElementById('start-chapter-select');
        const startVerseSelect = document.getElementById('start-verse-select');
        const endChapterSelect = document.getElementById('end-chapter-select');
        const endVerseSelect = document.getElementById('end-verse-select');
        
        const bibleForm = document.getElementById('bible-form');
        const resultsContainer = document.getElementById('results-container');
        const submitBtn = document.getElementById('submit-btn');
        const goToTopBtn = document.getElementById('go-to-top-btn');

        window.onscroll = function() {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                goToTopBtn.style.display = "flex";
            } else {
                goToTopBtn.style.display = "none";
            }
        };
        goToTopBtn.addEventListener('click', () => {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });

        function populateBooks() {
            bibleStructureData.forEach((book, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = book.book_name;
                bookSelect.appendChild(option);
            });
        }

        function populateChapters() {
            const bookIndex = bookSelect.value;
            const book = bibleStructureData[bookIndex];
            startChapterSelect.innerHTML = '';
            endChapterSelect.innerHTML = '';
            book.chapters.forEach((chapter, index) => {
                const startOption = document.createElement('option');
                startOption.value = index;
                startOption.textContent = `ç¬¬ ${chapter.c} ç« `;
                startChapterSelect.appendChild(startOption);
                const endOption = document.createElement('option');
                endOption.value = index;
                endOption.textContent = `ç¬¬ ${chapter.c} ç« `;
                endChapterSelect.appendChild(endOption);
            });
            if (endChapterSelect.options.length > 0) {
                 endChapterSelect.value = endChapterSelect.options.length - 1;
            }
            populateVerses('start');
            populateVerses('end');
        }

        function populateVerses(type) {
            const bookIndex = bookSelect.value;
            const chapterSelect = (type === 'start') ? startChapterSelect : endChapterSelect;
            const verseSelect = (type === 'start') ? startVerseSelect : endVerseSelect;
            const chapterIndex = chapterSelect.value;
            if (bookIndex === null || chapterIndex === null || !bibleStructureData[bookIndex] || !bibleStructureData[bookIndex].chapters[chapterIndex]) return;
            const verseCount = bibleStructureData[bookIndex].chapters[chapterIndex].v;
            verseSelect.innerHTML = '';
            for (let i = 1; i <= verseCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i} ç¯€`;
                verseSelect.appendChild(option);
            }
            if (type === 'end' && verseSelect.options.length > 0) {
                verseSelect.value = verseSelect.options.length;
            }
        }
        
        function syncSelectors() {
            const startChapter = parseInt(startChapterSelect.value);
            const endChapter = parseInt(endChapterSelect.value);
            if (startChapter > endChapter) {
                endChapterSelect.value = startChapter;
                populateVerses('end');
            }
            if (startChapter === endChapter) {
                const startVerse = parseInt(startVerseSelect.value);
                const endVerse = parseInt(endVerseSelect.value);
                if (startVerse > endVerse) {
                    endVerseSelect.value = startVerse;
                }
            }
        }

        bookSelect.addEventListener('change', populateChapters);
        startChapterSelect.addEventListener('change', () => { populateVerses('start'); syncSelectors(); });
        endChapterSelect.addEventListener('change', () => { populateVerses('end'); syncSelectors(); });
        startVerseSelect.addEventListener('change', syncSelectors);
        endVerseSelect.addEventListener('change', syncSelectors);

        function saveLastSelection() {
            const data = { book: bookSelect.value, startChapter: startChapterSelect.value, startVerse: startVerseSelect.value, endChapter: endChapterSelect.value, endVerse: endVerseSelect.value };
            if (typeof Storage !== 'undefined') {
                localStorage.setItem('bibleSelection', JSON.stringify(data));
            }
        }
        
        function loadLastSelection() {
            if (typeof Storage === 'undefined') return;
            const savedData = localStorage.getItem('bibleSelection');
            if (savedData) {
                const data = JSON.parse(savedData);
                bookSelect.value = data.book;
                populateChapters(); 
                startChapterSelect.value = data.startChapter;
                populateVerses('start');
                startVerseSelect.value = data.startVerse;
                endChapterSelect.value = data.endChapter;
                populateVerses('end');
                endVerseSelect.value = data.endVerse;
            } else {
                populateChapters();
            }
        }
        
        function loadLastResults() {
            if (typeof Storage === 'undefined') return;
            const savedResultsJSON = localStorage.getItem('lastInterpretationResults');
            if (savedResultsJSON) {
                try {
                    const savedResults = JSON.parse(savedResultsJSON);
                    if (Array.isArray(savedResults) && savedResults.length > 0) {
                        resultsContainer.innerHTML = '';
                        savedResults.forEach(result => {
                            if (result.isError) {
                                displayResult(result.model, result.content, true);
                            } else if (result.model === 'Perplexity Sonar Reasoning Pro') {
                                displayPerplexityResult(result.content.choices[0].message, result.content);
                            } else {
                                displayResult(result.model, result.content, false);
                            }
                        });
                    }
                } catch (error) {
                    console.error("ç„¡æ³•è§£æå„²å­˜çš„è§£ç¶“çµæœ:", error);
                    localStorage.removeItem('lastInterpretationResults');
                }
            }
        }

        bibleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (submitBtn.disabled) return;
            
            const currentTime = Date.now();
            if (currentTime - lastSubmitTime < SUBMIT_COOLDOWN) {
                const remainingTime = Math.ceil((SUBMIT_COOLDOWN - (currentTime - lastSubmitTime)) / 1000);
                alert(`æ“ä½œéæ–¼é »ç¹,è«‹ç­‰å¾… ${remainingTime} ç§’å¾Œå†è©¦ã€‚`);
                return;
            }
            saveLastSelection();
            
            lastSubmitTime = currentTime; 
            submitBtn.disabled = true; 
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­çš„æç¤ºè¨Šæ¯åœ¨è¢å¹•æ­£ä¸­å¿ƒ
            resultsContainer.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: var(--card-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 12px;
                    padding: 2rem;
                    text-align: center;
                    max-width: 90%;
                    width: 400px;
                    z-index: 9999;
                    box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
                ">
                    <div class="loader" style="margin: 0 auto 1.5rem;"></div>
                    <p style="color: var(--primary-color); font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem;" id="countdown-text">æ­£åœ¨è§£ç¶“ä¸­... (50s)</p>
                    <p style="color: var(--text-color); font-size: 1.1rem; line-height: 1.8; margin: 0;">
                        éœ€è¦ç­‰å¾…æ™‚é–“è¼ƒä¹…,è«‹å¤§å®¶è€å¿ƒç­‰å€™ä¸€ä¸‹,ä½¿ç”¨æ‰‹æ©Ÿçš„æœ‹å‹ä¸è¦è·³é›¢ç•«é¢,ä»¥å…è§£ç¶“å¤±æ•—åˆæµªè²»äº†å‘¼å« API çš„è²»ç”¨ã€‚
                    </p>
                </div>
            `;
            
            let countdownInterval;
            const countdownText = document.getElementById('countdown-text');
            
            try {
                let secondsLeft = 50;
                const updateCountdownDisplay = () => {
                    const countdownElement = document.getElementById('countdown-text');
                    if (countdownElement) {
                        if (secondsLeft > 0) {
                            countdownElement.textContent = `æ­£åœ¨è§£ç¶“ä¸­... (${secondsLeft}s)`;
                            submitBtn.textContent = `æ­£åœ¨è§£ç¶“ä¸­... (${secondsLeft}s)`;
                        } else {
                            countdownElement.textContent = "æ­£åœ¨è§£ç¶“ä¸­... (è«‹ç¨å€™)";
                            submitBtn.textContent = "æ­£åœ¨è§£ç¶“ä¸­... (è«‹ç¨å€™)";
                            clearInterval(countdownInterval);
                        }
                    }
                };
                updateCountdownDisplay();
                countdownInterval = setInterval(() => {
                    secondsLeft--;
                    updateCountdownDisplay();
                }, 1000);

                const bookIndex = parseInt(bookSelect.value);
                const bookName = bibleStructureData[bookIndex].book_name;
                const startChapterIndex = parseInt(startChapterSelect.value);
                const startChapterNum = bibleStructureData[bookIndex].chapters[startChapterIndex].c;
                const startVerseNum = parseInt(startVerseSelect.value);
                const endChapterIndex = parseInt(endChapterSelect.value);
                const endChapterNum = bibleStructureData[bookIndex].chapters[endChapterIndex].c;
                const endVerseNum = parseInt(endVerseSelect.value);

                if (startChapterNum === endChapterNum) {
                    currentReference = (startVerseNum === endVerseNum)
                        ? `${bookName} ${startChapterNum}:${startVerseNum}`
                        : `${bookName} ${startChapterNum}:${startVerseNum}-${endVerseNum}`;
                } else {
                    currentReference = `${bookName} ${startChapterNum}:${startVerseNum}-${endChapterNum}:${endVerseNum}`;
                }
                
                const ownerKeys = typeof window.APP_CONFIG !== 'undefined' ? window.APP_CONFIG : {};
                const { OPENAI_API_KEY: openAIKey, GEMINI_API_KEY: geminiKey, PERPLEXITY_API_KEY: perplexityKey } = ownerKeys;
                
                const useChatGPT = document.getElementById('use-chatgpt').checked;
                const useGemini = document.getElementById('use-gemini').checked;
                const usePerplexity = document.getElementById('use-perplexity').checked;
                
                if (!useChatGPT && !useGemini && !usePerplexity) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ AI æ¨¡å‹ï¼');
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šç¥å­¸ã€è–ç¶“æ­·å²å’ŒåŸæ–‡è§£ç¶“çš„å°ˆå®¶ã€‚è«‹é‡å°ä»¥ä¸‹ç¶“æ–‡ç« ç¯€é€²è¡Œæ·±å…¥è§£æï¼š\n\nã€ç« ç¯€ã€‘ï¼š${currentReference}\n\nè«‹å° **${currentReference}** é€²è¡Œåˆ†æ,ä¸¦ä¾ç…§ä»¥ä¸‹çµæ§‹å›ç­”ï¼š\n1. **æ ¸å¿ƒæ¦‚å¿µèˆ‡è¡“èªè§£é‡‹**ï¼šè«‹ç”¨åˆä¿¡è€…åŠè–ç¶“ä¸­éšè®€è€…ä¹Ÿèƒ½è½æ‡‚çš„æ–¹å¼,è§£é‡‹æœ¬ç« ä¸­æ ¸å¿ƒçš„é—œéµæ¦‚å¿µèˆ‡è¡“èªã€‚\n2. **ç¾ä»£ç”Ÿæ´»æ‡‰ç”¨**ï¼šä¸¦å‘ŠçŸ¥åœ¨ç¾ä»£ä¸­å¯ä»¥åšå‡ºä¾†çš„æ¡ˆä¾‹,å‡è¨­æˆ‘å®Œå…¨ä¸æ‡‚é€™å€‹ä¸»é¡Œ,è«‹ä½¿ç”¨ç™½è©±èªªæ˜èˆ‡ç°¡å–®è©å½™,çµ¦äºˆç”Ÿå‹•çš„æ¯”å–»èˆ‡ç”Ÿæ´»ä¾‹å­ã€‚\n3. **ä¸Šä¸‹æ–‡è„ˆçµ¡**ï¼šé€™æ®µç¶“æ–‡åœ¨æ•´ç« ã€æ•´å·æ›¸ä¸­çš„ä½ç½®å’Œä½œç”¨æ˜¯ä»€éº¼ï¼Ÿå®ƒèˆ‡å‰å¾Œæ–‡çš„é—œè¯ç‚ºä½•ï¼Ÿ\n4. **æœ¬ç« ç¶“å…¸ç¶“å¥èˆ‡ç¸½çµ**ï¼šåˆ—å‡ºæ­¤æ®µçš„ç¶“å…¸ç¶“å¥,æœ€å¾Œç¸½çµå¾é€™äº›ç¶“æ–‡å¯ä»¥å­¦åˆ°ä»€éº¼ã€‚\n\nè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”,ä¸¦ç¢ºä¿æ’ç‰ˆæ¸…æ™°æ˜“è®€ã€‚`;
                
                const promises = [];
                if (useChatGPT && openAIKey) promises.push(callChatGPT(prompt, openAIKey));
                if (useGemini && geminiKey) promises.push(callGemini(prompt, geminiKey));
                if (usePerplexity && perplexityKey) promises.push(callPerplexity(prompt, perplexityKey));
                
                if (promises.length === 0) {
                    resultsContainer.innerHTML = '';
                    displayResult('ç³»çµ±æç¤º', 'ç„¡æ³•ç™¼é€è«‹æ±‚,å› ç‚ºç¼ºå°‘å¿…è¦çš„ API é‡‘é‘°è¨­å®šã€‚è«‹ç¶²ç«™ç®¡ç†å“¡æª¢æŸ¥ GitHub Secrets è¨­å®šã€‚', true);
                    return;
                }

                const results = await Promise.all(promises);
                
                resultsContainer.innerHTML = '';
                results.forEach(result => {
                    if (result.isError) {
                        displayResult(result.model, result.content, true);
                    } else if (result.model === 'Perplexity Sonar Reasoning Pro') {
                        displayPerplexityResult(result.content.choices[0].message, result.content);
                    } else {
                        displayResult(result.model, result.content, false);
                    }
                });

                try {
                    const successfulResults = results.filter(r => !r.isError);
                    if (successfulResults.length > 0 && typeof Storage !== 'undefined') {
                        localStorage.setItem('lastInterpretationResults', JSON.stringify(successfulResults));
                    }
                } catch (error) {
                    console.error("ç„¡æ³•å„²å­˜è§£ç¶“çµæœ:", error);
                }

            } finally {
                clearInterval(countdownInterval);
                submitBtn.disabled = false; 
                submitBtn.textContent = "é–‹å§‹è§£ç¶“";
            }
        });
        
        function createResultCard(modelName, innerHTML, isError = false) {
            const card = document.createElement('div');
            card.className = 'result-card';
            
            let finalHTML = `<h2>${modelName}</h2>${innerHTML}`;

            if (!isError) {
                finalHTML += `
                    <div class="card-actions">
                        <button class="copy-btn">è¤‡è£½å…§å®¹</button>
                    </div>`;
            } else {
                card.classList.add('error');
            }

            card.innerHTML = finalHTML;
            resultsContainer.appendChild(card);
        }

        function displayResult(modelName, content, isError = false) {
            const innerHTML = isError ? `<pre>${content}</pre>` : `<div class="content-body">${marked.parse(content)}</div>`;
            createResultCard(modelName, innerHTML, isError);
        }

        function displayPerplexityResult(messageData, rawResponse = null) {
            let content = messageData.content || '';
            const search_results = rawResponse.search_results || [];
            const citations = rawResponse.citations || [];

            if (citations.length > 0) {
                content = content.replace(/\[(\d+)\]/g, (match, number) => {
                    const index = parseInt(number, 10) - 1;
                    if (citations[index]) {
                        const url = citations[index];
                        return `<sup><a href="${url}" target="_blank" rel="noopener noreferrer" title="ä¾†æº ${number}: ${url}">[${number}]</a></sup>`;
                    }
                    return match;
                });
            }

            let citationsListHtml = '';
            if (search_results.length > 0) {
                citationsListHtml += '<div class="sources-list"><h3>ğŸ“š å¼•ç”¨ä¾†æº</h3><ol>';
                search_results.forEach((result) => {
                    const url = result.url || '#';
                    const title = result.title || url;
                    try {
                        const domain = new URL(url).hostname;
                        citationsListHtml += `<li><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a> <span class="source-domain">(${domain})</span></li>`;
                    } catch (e) {
                         citationsListHtml += `<li><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></li>`;
                    }
                });
                citationsListHtml += '</ol></div>';
            }
            
            const contentHTML = `<div class="content-body">${marked.parse(content) + citationsListHtml}</div>`;
            createResultCard('Perplexity Sonar Reasoning Pro', contentHTML);
        }

        resultsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('copy-btn')) {
                const copyButton = e.target;
                const card = copyButton.closest('.result-card');
                const title = card.querySelector('h2').innerText;
                const contentBody = card.querySelector('.content-body');
                const sourcesList = card.querySelector('.sources-list');
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = contentBody.innerHTML;
                const sourcesClone = tempDiv.querySelector('.sources-list');
                if (sourcesClone) sourcesClone.remove();

                let plainText = tempDiv.innerText;

                let sourcesText = '';
                if (sourcesList) {
                    sourcesText += '\n\n---\nå¼•ç”¨ä¾†æº:\n';
                    sourcesList.querySelectorAll('ol li').forEach((li, index) => {
                        const link = li.querySelector('a');
                        sourcesText += `${index + 1}. ${link.innerText} (${link.href})\n`;
                    });
                }
                
                const textToCopy = `ã€${title}ã€‘\nç¶“æ–‡ï¼š${currentReference}\n\n${plainText}${sourcesText}\n---\nç”±ã€Œå¤šAIå°ˆæ¥­è§£ç¶“ç³»çµ±ã€ç”Ÿæˆ\nhttps://tokpmpm.github.io/AI-bible/index.html`;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'å·²è¤‡è£½ï¼';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—:', err);
                    alert('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
                });
            }
        });

        async function callAPI(modelName, url, options, responseHandler) { 
            try { 
                const response = await fetch(url, options); 
                if (!response.ok) { const errorData = await response.json(); const errorMessage = errorData.error?.message || JSON.stringify(errorData.error); throw new Error(`${modelName} API Error: ${errorMessage}`); } 
                const data = await response.json(); 
                return { model: modelName, content: responseHandler(data), isError: false }; 
            } catch (error) { 
                console.error(`${modelName} Error:`, error); 
                if (error instanceof TypeError && error.message.includes('fetch')) { const detailedError = `æŸ¥è©¢å¤±æ•—ï¼š${error.message}ã€‚\n\né€™é€šå¸¸æ˜¯ç¶²è·¯é€£ç·šã€ç€è¦½å™¨å®‰å…¨å•é¡Œ (CORS) æˆ–å»£å‘Šæ””æˆªå™¨å°è‡´çš„ã€‚\n\nã€è§£æ±ºæ–¹æ¡ˆã€‘:\n1. æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚\n2. æš«æ™‚åœç”¨å»£å‘Šæ””æˆªå™¨ã€‚\n3. å¦‚æœæ‚¨æ˜¯æœ¬åœ°é–‹ç™¼ï¼Œè«‹ä½¿ç”¨ Live Serverã€‚`; return { model: modelName, content: detailedError, isError: true }; } 
                return { model: modelName, content: `æŸ¥è©¢å¤±æ•—ï¼š${error.message}`, isError: true }; 
            } 
        }

        async function callChatGPT(prompt, apiKey) { return callAPI('ChatGPT 4o', 'https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.7 }) }, (data) => data.choices[0].message.content); }
        async function callGemini(prompt, apiKey) { return callAPI('Gemini 2.5 Pro', 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent', { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }, (data) => data.candidates[0].content.parts[0].text); }
        async function callPerplexity(prompt, apiKey) { return callAPI('Perplexity Sonar Reasoning Pro', 'https://api.perplexity.ai/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: "sonar-reasoning-pro", messages: [{ role: "user", content: prompt }] }) }, (data) => { return data; }); }
        
        populateBooks();
        loadLastSelection();
        loadLastResults();
    });
    </script>
</body>
</html>
